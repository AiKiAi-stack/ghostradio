<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>GhostRadio Dashboard</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#067ff9",
                        "background-light": "#f5f7f8",
                        "background-dark": "#0f1923",
                        "surface-dark": "#16202a",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "mono": ["monospace"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px" },
                    boxShadow: {
                        "neon": "0 0 15px rgba(6, 127, 249, 0.5)",
                        "glass": "0 4px 30px rgba(0, 0, 0, 0.1)"
                    }
                },
            },
        }
    </script>
    <style>
        body { font-family: "Space Grotesk", sans-serif; }
        .glass-panel {
            background: rgba(22, 32, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .terminal-scroll::-webkit-scrollbar { width: 6px; }
        .terminal-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        @keyframes pulse-dot { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
        .animate-pulse-dot { animation: pulse-dot 2s infinite ease-in-out; }
        .modal-backdrop { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-background-dark text-white h-screen w-full overflow-hidden flex">
    <!-- Sidebar -->
    <aside class="w-64 h-full bg-[#0d141c] border-r border-white/5 flex flex-col justify-between shrink-0 z-20">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-10">
                <div class="relative w-10 h-10 rounded-full overflow-hidden bg-gradient-to-br from-primary to-purple-600 shadow-neon">
                    <img class="w-full h-full object-cover opacity-80" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAGFCXIgSZtbpS5fXmdeWmrUJgNeinaZJLFZIFZ4tTb5Ket-fzftbxT0whmMzK09KpA4Zd5_7wDOUYry8a8sqmUTiPt4o4_CgGw0hkTS_wFGhZZHOELR5L9JalxSwKfj-wk8Wi-on16wpFVF8In8LkJNjD0vSNJseXPMXtOjrVxTX4h0GAjusaLAdDQDDUqd0s9OIpDEjm8RpDG3C_z_9_3Yx3OX4NShMyyMQpgMBDNyJdQU7AWDXiJBwDVne_c-sW1cAVvD41qY2cb"/>
                </div>
                <div>
                    <h1 class="text-white text-lg font-bold leading-none tracking-wide">GHOST<span class="text-primary font-light">RADIO</span></h1>
                    <p class="text-[#6b7b8a] text-xs font-normal mt-1">v2.5.0 Spectral</p>
                </div>
            </div>
            <nav class="flex flex-col gap-2">
                <a class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary/10 border border-primary/20 text-white shadow-[0_0_10px_rgba(6,127,249,0.1)] group transition-all" href="#">
                    <span class="material-symbols-outlined text-primary group-hover:text-white transition-colors">dashboard</span>
                    <span class="text-sm font-medium">Dashboard</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#9babbb] hover:bg-white/5 hover:text-white transition-all" href="#">
                    <span class="material-symbols-outlined">headphones</span>
                    <span class="text-sm font-medium">Episodes</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#9babbb] hover:bg-white/5 hover:text-white transition-all" href="#">
                    <span class="material-symbols-outlined">inventory_2</span>
                    <span class="text-sm font-medium">Archive</span>
                </a>
                <button onclick="toggleModal('settingsModal')" class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#9babbb] hover:bg-white/5 hover:text-white transition-all w-full text-left">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-sm font-medium">Settings</span>
                </button>
            </nav>
        </div>
        <div class="p-6 border-t border-white/5">
            <div class="flex items-center gap-3 p-3 rounded-lg bg-surface-dark border border-white/5">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 flex items-center justify-center">
                    <span class="material-symbols-outlined text-sm text-white">person</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">Operator</p>
                    <p class="text-xs text-[#6b7b8a] truncate">Pro Plan</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto relative flex flex-col">
        <div class="absolute top-0 left-0 w-full h-[500px] bg-gradient-to-b from-primary/5 to-transparent pointer-events-none z-0"></div>
        <div class="relative z-10 p-6 md:p-10 max-w-7xl mx-auto w-full flex flex-col gap-8">
            <!-- Header -->
            <div class="flex justify-between items-center pt-2">
                <div>
                    <h2 class="text-3xl font-bold tracking-tight text-white">Dashboard</h2>
                    <p class="text-[#9babbb] text-sm mt-1">Command center for spectral audio generation.</p>
                </div>
                <div class="flex gap-2">
                    <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse-dot"></div>
                        <span class="text-[10px] text-green-400 font-mono uppercase tracking-wider">WebSocket Active</span>
                    </div>
                </div>
            </div>

            <!-- Hero Generator Input -->
            <div class="glass-panel rounded-2xl p-1 shadow-glass">
                <div class="bg-gradient-to-b from-white/5 to-transparent rounded-xl p-6 md:p-10 flex flex-col items-center gap-6">
                    <div class="text-center space-y-2">
                        <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">Summon a Podcast</h1>
                        <p class="text-[#9babbb] text-base font-light">Choose your mode and paste a source to begin.</p>
                    </div>

                    <!-- Mode Selector -->
                    <div class="flex bg-[#0d141c] p-1 rounded-xl border border-white/5 w-full max-w-md">
                        <button onclick="setMode(0)" id="mode0" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-primary text-white shadow-neon">Summarize</button>
                        <button onclick="setMode(4)" id="mode4" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all text-[#9babbb] hover:text-white">Expand Topic</button>
                        <button onclick="setMode(3)" id="mode3" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all text-[#9babbb] hover:text-white">Direct Script</button>
                    </div>

                    <div class="w-full max-w-2xl relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-primary/20 via-purple-500/20 to-primary/20 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-500"></div>
                        <div class="relative flex items-center bg-[#0d141c] rounded-xl border border-white/10 overflow-hidden shadow-2xl">
                            <div class="pl-4 text-[#475569]">
                                <span id="inputIcon" class="material-symbols-outlined text-xl">link</span>
                            </div>
                            <input id="mainInput" class="w-full bg-transparent border-none text-white placeholder-[#475569] focus:ring-0 px-4 py-4 text-lg font-light h-16" placeholder="https://medium.com/article..." type="text"/>
                            <div class="pr-2">
                                <button onclick="generate()" class="bg-primary hover:bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold tracking-wide shadow-neon transition-all flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">bolt</span>
                                    <span>GENERATE</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Columns -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left: Configuration -->
                <div class="glass-panel rounded-xl flex flex-col overflow-hidden h-full">
                    <div class="px-5 py-4 border-b border-white/5 bg-white/5 flex items-center justify-between">
                        <h3 class="text-sm font-medium uppercase tracking-wider text-[#9babbb]">Configuration</h3>
                        <span class="material-symbols-outlined text-[#9babbb] text-sm">tune</span>
                    </div>
                    <div class="p-6 flex flex-col gap-6">
                        <!-- Speaker Selection -->
                        <div class="flex flex-col gap-3">
                            <label class="text-sm text-white font-medium">Select Duo (Pick 2)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="toggleSpeaker('zh_female_mizaitongxue_v2_saturn_bigtts', 'mizai')" id="spk_mizai" class="speaker-btn p-2 rounded-lg border border-white/10 bg-[#0d141c] flex items-center gap-2 hover:border-primary/50 transition-all">
                                    <div class="w-6 h-6 rounded-full bg-purple-500/20 flex items-center justify-center text-[10px]">üéôÔ∏è</div>
                                    <span class="text-xs">Mizai</span>
                                </button>
                                <button onclick="toggleSpeaker('zh_male_dayixiansheng_v2_saturn_bigtts', 'dayi')" id="spk_dayi" class="speaker-btn p-2 rounded-lg border border-white/10 bg-[#0d141c] flex items-center gap-2 hover:border-primary/50 transition-all">
                                    <div class="w-6 h-6 rounded-full bg-blue-500/20 flex items-center justify-center text-[10px]">üéôÔ∏è</div>
                                    <span class="text-xs">Mr. Dayi</span>
                                </button>
                                <button onclick="toggleSpeaker('zh_male_liufei_v2_saturn_bigtts', 'liufei')" id="spk_liufei" class="speaker-btn p-2 rounded-lg border border-white/10 bg-[#0d141c] flex items-center gap-2 hover:border-primary/50 transition-all">
                                    <div class="w-6 h-6 rounded-full bg-orange-500/20 flex items-center justify-center text-[10px]">üéôÔ∏è</div>
                                    <span class="text-xs">Liu Fei</span>
                                </button>
                                <button onclick="toggleSpeaker('zh_male_xiaolei_v2_saturn_bigtts', 'xiaolei')" id="spk_xiaolei" class="speaker-btn p-2 rounded-lg border border-white/10 bg-[#0d141c] flex items-center gap-2 hover:border-primary/50 transition-all">
                                    <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center text-[10px]">üéôÔ∏è</div>
                                    <span class="text-xs">Xiao Lei</span>
                                </button>
                            </div>
                        </div>

                        <!-- Atmosphere Toggles -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 rounded-lg bg-white/5 border border-white/5 flex flex-col gap-1">
                                <span class="text-[10px] uppercase text-[#6b7b8a] font-bold">Intro Music</span>
                                <input type="checkbox" id="useHeadMusic" checked class="w-8 h-4 bg-gray-700 rounded-full appearance-none checked:bg-primary transition-all cursor-pointer"/>
                            </div>
                            <div class="p-3 rounded-lg bg-white/5 border border-white/5 flex flex-col gap-1">
                                <span class="text-[10px] uppercase text-[#6b7b8a] font-bold">Outro Music</span>
                                <input type="checkbox" id="useTailMusic" class="w-8 h-4 bg-gray-700 rounded-full appearance-none checked:bg-primary transition-all cursor-pointer"/>
                            </div>
                        </div>

                        <!-- Advanced Toggle -->
                        <div class="border-t border-white/5 pt-4">
                            <button onclick="document.getElementById('advancedPanel').classList.toggle('hidden')" class="text-[10px] uppercase text-primary font-bold flex items-center gap-1 hover:text-white transition-colors">
                                Advanced Settings <span class="material-symbols-outlined text-xs">stat_minus_1</span>
                            </button>
                            <div id="advancedPanel" class="hidden mt-4 space-y-4">
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <label class="text-[10px] text-[#6b7b8a] uppercase font-bold">Truncate Length</label>
                                        <span id="truncVal" class="text-[10px] text-primary font-mono">12000</span>
                                    </div>
                                    <input type="range" id="inputMaxLength" min="1000" max="32000" value="12000" step="1000" class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-primary" oninput="document.getElementById('truncVal').innerText = this.value"/>
                                </div>
                                <div class="flex items-center justify-between p-2 rounded bg-white/5 border border-white/5">
                                    <span class="text-[10px] text-[#6b7b8a] uppercase font-bold">AIGC Watermark</span>
                                    <input type="checkbox" id="aigcWatermark" class="w-6 h-3 bg-gray-700 rounded-full appearance-none checked:bg-primary transition-all cursor-pointer"/>
                                </div>
                                <div class="flex items-center justify-between p-2 rounded bg-white/5 border border-white/5">
                                    <span class="text-[10px] text-[#6b7b8a] uppercase font-bold">Random Order</span>
                                    <input type="checkbox" id="randomOrder" checked class="w-6 h-3 bg-gray-700 rounded-full appearance-none checked:bg-primary transition-all cursor-pointer"/>
                                </div>
                            </div>
                        </div>

                        <!-- Speed Slider -->
                        <div class="flex flex-col gap-3">
                            <div class="flex justify-between items-center">
                                <label class="text-sm text-white font-medium">Speech Rate</label>
                                <span id="speedVal" class="text-xs text-primary font-mono">Normal (0)</span>
                            </div>
                            <input type="range" id="speechRate" min="-50" max="100" value="0" step="1" class="w-full h-1.5 bg-white/10 rounded-lg appearance-none cursor-pointer accent-primary" oninput="updateSpeedLabel(this.value)"/>
                        </div>

                        <!-- Technical Params -->
                        <div class="flex flex-col gap-3">
                            <label class="text-sm text-white font-medium">Sample Rate</label>
                            <select id="sampleRate" class="w-full bg-[#0d141c] border border-white/10 rounded-lg text-xs py-2 px-3 focus:ring-primary appearance-none cursor-pointer">
                                <option value="24000">High Quality (24kHz)</option>
                                <option value="16000">Standard (16kHz)</option>
                                <option value="48000">Ultra (48kHz)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Right: Live Terminal -->
                <div class="glass-panel rounded-xl flex flex-col overflow-hidden lg:col-span-2 h-full bg-[#05080a]/80">
                    <div class="px-5 py-4 border-b border-white/5 bg-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-green-400 text-sm">terminal</span>
                            <h3 class="text-sm font-medium uppercase tracking-wider text-[#9babbb]">Live Terminal</h3>
                        </div>
                        <button onclick="clearTerminal()" class="text-[10px] text-[#475569] hover:text-white transition-colors">CLEAR</button>
                    </div>
                    <div id="terminal" class="flex-1 p-6 font-mono text-sm overflow-y-auto terminal-scroll min-h-[300px]">
                        <p class="text-[#6b7b8a]"><span class="text-blue-400">[SYSTEM]</span> Ready to summon.</p>
                    </div>
                </div>
            </div>

            <!-- Recent Episodes Gallery -->
            <div class="pb-10">
                <div class="flex justify-between items-end mb-6">
                    <h3 class="text-xl font-bold text-white">Recent Hauntings</h3>
                    <button onclick="loadEpisodes()" class="text-sm text-primary hover:text-white transition-colors flex items-center gap-1">
                        Refresh <span class="material-symbols-outlined text-sm">refresh</span>
                    </button>
                </div>
                <div id="episodeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 modal-backdrop" onclick="toggleModal('settingsModal')"></div>
        <div class="glass-panel w-full max-w-md rounded-2xl relative overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-white/10 bg-white/5 flex justify-between items-center">
                <h3 class="text-lg font-bold">Provider Credentials</h3>
                <button onclick="toggleModal('settingsModal')" class="material-symbols-outlined hover:text-red-400">close</button>
            </div>
            <div class="p-6 flex flex-col gap-5">
                <div class="space-y-2">
                    <label class="text-xs uppercase font-bold text-[#6b7b8a]">Volcengine AppID</label>
                    <input type="password" id="vcAppId" placeholder="Enter your AppID" class="w-full bg-[#0d141c] border border-white/10 rounded-xl px-4 py-3 focus:ring-primary text-sm"/>
                </div>
                <div class="space-y-2">
                    <label class="text-xs uppercase font-bold text-[#6b7b8a]">Volcengine Access Token</label>
                    <input type="password" id="vcToken" placeholder="Enter your Access Token" class="w-full bg-[#0d141c] border border-white/10 rounded-xl px-4 py-3 focus:ring-primary text-sm"/>
                </div>
                <div class="space-y-2">
                    <label class="text-xs uppercase font-bold text-[#6b7b8a]">NVIDIA/OpenAI API Key (Optional)</label>
                    <input type="password" id="genKey" placeholder="Stored on server if empty" class="w-full bg-[#0d141c] border border-white/10 rounded-xl px-4 py-3 focus:ring-primary text-sm"/>
                </div>
                <button onclick="saveSettings()" class="w-full bg-primary py-3 rounded-xl font-bold shadow-neon hover:bg-blue-600 transition-all mt-2">SAVE CONFIGURATION</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 0;
        let selectedSpeakers = [];

        // UI Helpers
        function toggleModal(id) {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden');
        }

        function setMode(mode) {
            currentMode = mode;
            ['mode0', 'mode4', 'mode3'].forEach(id => {
                document.getElementById(id).classList.remove('bg-primary', 'text-white', 'shadow-neon');
                document.getElementById(id).classList.add('text-[#9babbb]');
            });
            document.getElementById('mode' + mode).classList.add('bg-primary', 'text-white', 'shadow-neon');
            document.getElementById('mode' + mode).classList.remove('text-[#9babbb]');
            
            const input = document.getElementById('mainInput');
            const icon = document.getElementById('inputIcon');
            if(mode === 0) { input.placeholder = "https://article-url.com..."; icon.innerText = "link"; }
            if(mode === 4) { input.placeholder = "e.g. History of Rome..."; icon.innerText = "psychology"; }
            if(mode === 3) { input.placeholder = '[{"speaker": "...", "text": "..."}]'; icon.innerText = "code"; }
        }

        function toggleSpeaker(id, shortId) {
            const index = selectedSpeakers.indexOf(id);
            const btnId = 'spk_' + shortId;
            
            if (index > -1) {
                // Deselect
                selectedSpeakers.splice(index, 1);
                document.getElementById(btnId).classList.remove('border-primary', 'bg-primary/10', 'shadow-neon/20');
            } else {
                // Select (Limit to 2)
                if (selectedSpeakers.length >= 2) {
                    // Remove first one
                    const removedId = selectedSpeakers.shift();
                    const removedShort = removedId.split('_')[2].replace('tongxue', 'mizai').replace('dayixiansheng', 'dayi').replace('liufei', 'liufei').replace('xiaolei', 'xiaolei').split('v2')[0].replace('saturn','').replace('bigtts','').trim();
                    // Just find the btn that has this full ID
                    document.querySelectorAll('.speaker-btn').forEach(btn => {
                        btn.classList.remove('border-primary', 'bg-primary/10', 'shadow-neon/20');
                    });
                }
                selectedSpeakers.push(id);
                // Re-apply styles to all selected
                selectedSpeakers.forEach(sid => {
                   const sShort = sid.includes('mizai') ? 'mizai' : (sid.includes('dayi') ? 'dayi' : (sid.includes('liufei') ? 'liufei' : 'xiaolei'));
                   document.getElementById('spk_' + sShort).classList.add('border-primary', 'bg-primary/10', 'shadow-neon/20');
                });
            }
        }

        function updateSpeedLabel(val) {
            let text = val > 0 ? `Fast (+${val})` : (val < 0 ? `Slow (${val})` : "Normal (0)");
            document.getElementById('speedVal').innerText = text;
        }

        function log(msg, type = 'info') {
            const t = document.getElementById('terminal');
            const p = document.createElement('p');
            const time = new Date().toLocaleTimeString();
            let color = "text-[#6b7b8a]";
            if(type === 'error') color = "text-red-400";
            if(type === 'success') color = "text-green-400";
            
            p.className = color;
            p.innerHTML = `<span class="text-blue-400">[${time}]</span> ${msg}`;
            t.appendChild(p);
            t.scrollTop = t.scrollHeight;
        }

        function clearTerminal() { document.getElementById('terminal').innerHTML = ''; }

        // Simple Obfuscation for transit
        const crypt = {
            enc: (str) => btoa(unescape(encodeURIComponent(str))),
            dec: (str) => decodeURIComponent(escape(atob(str)))
        };

        // Settings Logic
        function saveSettings() {
            localStorage.setItem('gr_vc_appid', document.getElementById('vcAppId').value);
            localStorage.setItem('gr_vc_token', document.getElementById('vcToken').value);
            localStorage.setItem('gr_gen_key', document.getElementById('genKey').value);
            log("Credentials updated successfully.", "success");
            toggleModal('settingsModal');
        }

        function loadSettings() {
            document.getElementById('vcAppId').value = localStorage.getItem('gr_vc_appid') || '';
            document.getElementById('vcToken').value = localStorage.getItem('gr_vc_token') || '';
            document.getElementById('genKey').value = localStorage.getItem('gr_gen_key') || '';
        }

        // API Interaction
        async function generate() {
            const input = document.getElementById('mainInput').value;
            if(!input) return log("Please provide an input.", "error");

            // Obfuscate sensitive tokens for transit
            const rawAppId = localStorage.getItem('gr_vc_appid');
            const rawToken = localStorage.getItem('gr_vc_token');
            
            const tts_config = {
                provider: "volcengine",
                // Send as obfuscated strings
                appid: crypt.enc(rawAppId || ""),
                token: crypt.enc(rawToken || ""),
                is_encoded: true, // Tell backend to decode
                action: currentMode,
                use_head_music: document.getElementById('useHeadMusic').checked,
                use_tail_music: document.getElementById('useTailMusic').checked,
                aigc_watermark: document.getElementById('aigcWatermark').checked,
                random_order: document.getElementById('randomOrder').checked,
                input_text_max_length: parseInt(document.getElementById('inputMaxLength').value),
                speech_rate: parseInt(document.getElementById('speechRate').value),
                sample_rate: parseInt(document.getElementById('sampleRate').value),
                speakers: selectedSpeakers
            };

            log(`Summoning task in mode ${currentMode}...`);
            
            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: currentMode === 0 ? input : "",
                        prompt_text: currentMode === 4 ? input : "",
                        nlp_texts: currentMode === 3 ? JSON.parse(input) : null,
                        tts_config: tts_config,
                        need_summary: currentMode === 0
                    })
                });
                const data = await res.json();
                if(data.success) {
                    log(`Job accepted: ${data.job_id}. Tracking progress...`, "success");
                    trackJob(data.job_id);
                } else {
                    log(`Summon failed: ${data.error}`, "error");
                }
            } catch (e) {
                log(`Ritual interrupted: ${e.message}`, "error");
            }
        }

        async function trackJob(id) {
            const interval = setInterval(async () => {
                const res = await fetch(`/api/progress/${id}`);
                const data = await res.json();
                if(data.status === 'completed') {
                    log(`Generation complete! Episode is ready.`, "success");
                    clearInterval(interval);
                    loadEpisodes();
                } else if (data.status === 'failed') {
                    log(`Job failed: ${data.error}`, "error");
                    clearInterval(interval);
                } else {
                    log(`${data.stage.toUpperCase()}: ${data.progress}% - ${data.message}`);
                }
            }, 3000);
        }

        async function loadEpisodes() {
            const res = await fetch('/api/episodes');
            const data = await res.json();
            const grid = document.getElementById('episodeGrid');
            grid.innerHTML = data.map(ep => `
                <div class="glass-panel p-5 rounded-xl border border-white/5 hover:border-primary/50 transition-all group cursor-pointer">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-800 to-black flex items-center justify-center">
                            <span class="material-symbols-outlined text-white group-hover:text-primary transition-colors">graphic_eq</span>
                        </div>
                        <span class="text-xs font-mono text-[#6b7b8a]">${ep.size_mb} MB</span>
                    </div>
                    <h4 class="text-lg font-bold text-white mb-1 group-hover:text-primary transition-colors">${ep.title}</h4>
                    <p class="text-xs text-[#6b7b8a] mb-4">${new Date(ep.created).toLocaleString()}</p>
                    <div class="flex items-center justify-between border-t border-white/5 pt-4">
                        <a href="/${ep.audio_file}" download class="hover:text-white text-[#9babbb]"><span class="material-symbols-outlined text-lg">download</span></a>
                        <audio controls class="h-8 w-32 opacity-40 hover:opacity-100 transition-opacity">
                            <source src="/${ep.audio_file}" type="audio/mpeg">
                        </audio>
                    </div>
                </div>
            `).join('');
        }

        window.onload = () => {
            loadSettings();
            loadEpisodes();
            log("GhostRadio Spectral Dashboard initialized.");
        };
    </script>
</body>
</html>
